import{Actor as e}from"@dfinity/agent";import{fileTypeFromBuffer as t}from"file-type";import n from"p-limit";var r=function(e){var t=e.IDL,n=t.Record({}),r=t.Nat,o=t.Text,i=t.Record({key:o,content_type:t.Text}),c=t.Record({key:o,content_encoding:t.Text}),s=t.Record({key:o}),u=t.Nat,a=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),chunk_ids:t.Vec(u),content_encoding:t.Text}),l=t.Variant({CreateAsset:i,UnsetAssetContent:c,DeleteAsset:s,SetAssetContent:a,Clear:n}),h=t.Tuple(t.Text,t.Text),d=t.Record({url:t.Text,method:t.Text,body:t.Vec(t.Nat8),headers:t.Vec(h)}),f=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text}),m=t.Record({token:t.Opt(f),body:t.Vec(t.Nat8)}),y=t.Variant({Callback:t.Record({token:f,callback:t.Func([f],[t.Opt(m)],["query"])})}),p=t.Record({body:t.Vec(t.Nat8),headers:t.Vec(h),streaming_strategy:t.Opt(y),status_code:t.Nat16}),_=t.Int;return t.Service({authorize:t.Func([t.Principal],[],[]),clear:t.Func([n],[],[]),commit_batch:t.Func([t.Record({batch_id:r,operations:t.Vec(l)})],[],[]),create_asset:t.Func([i],[],[]),create_batch:t.Func([t.Record({})],[t.Record({batch_id:r})],[]),create_chunk:t.Func([t.Record({content:t.Vec(t.Nat8),batch_id:r})],[t.Record({chunk_id:u})],[]),delete_content:t.Func([s],[],[]),get:t.Func([t.Record({key:o,accept_encodings:t.Vec(t.Text)})],[t.Record({content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text,total_length:t.Nat})],["query"]),get_chunk:t.Func([t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text})],[t.Record({content:t.Vec(t.Nat8)})],["query"]),http_request:t.Func([d],[p],["query"]),http_request_streaming_callback:t.Func([f],[t.Opt(m)],["query"]),list:t.Func([t.Record({})],[t.Vec(t.Record({key:o,encodings:t.Vec(t.Record({modified:_,sha256:t.Opt(t.Vec(t.Nat8)),length:t.Nat,content_encoding:t.Text})),content_type:t.Text}))],["query"]),set_asset_content:t.Func([a],[],[]),store:t.Func([t.Record({key:o,content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text})],[],[]),unset_asset_content:t.Func([c],[],[])})},o=["concurrency","maxSingleFileSize","maxChunkSize","eventListener"],i="undefined"!=typeof window&&void 0!==window.document,c="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,s="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,u=i?Promise.resolve(window.crypto):s?Promise.resolve(self.crypto):c?import("crypto"):Promise.resolve(),a=function(e,n){try{var r,o,a=function(e){var r;function a(e){function n(){return{fileName:l,path:d,content:o,contentType:h,contentEncoding:f,sha256:e}}var r=function(){if(!h)return Promise.resolve(t(Uint8Array.from(o))).then(function(e){var t=e.mime;h=void 0===t?"application/octet-stream":t})}();return r&&r.then?r.then(n):n()}d.startsWith("/")||(d="/"+d),d.endsWith("/")||(d+="/");var f=null!=(r=null==n?void 0:n.contentEncoding)?r:"identity",m=null==n?void 0:n.sha256;return m?Promise.resolve(function(e){try{var t,n=function(n){return t?n:function(){if(c)return Promise.resolve(u).then(function(t){return Array.from(t.createHash("sha256").update(new Uint8Array(e)).digest())})}()},r=function(){if(i||s)return Promise.resolve(u).then(function(n){return Promise.resolve(n.subtle.digest("SHA-256",new Uint8Array(e))).then(function(e){var n=Array.from(new Uint8Array(e));return t=1,n})})}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(e){return Promise.reject(e)}}(o)).then(a):a(m)},l=null==n?void 0:n.fileName,h=null==n?void 0:n.contentType,d=null!=(r=null==n?void 0:n.path)?r:"/",f=function(){if(!(e instanceof Uint8Array))return function(){if(!Array.isArray(e)||!e.every(function(e){return"number"==typeof e}))return function(){if(e instanceof Blob)return Promise.resolve(new Promise(function(t){var n=new FileReader;n.addEventListener("load",function(){t(Array.from(Uint8Array.from(n.result)))}),n.readAsArrayBuffer(e)})).then(function(t){if(o=t,!l){if(!(e instanceof File))throw'"fileName" property is required in options';l=e.name}h||(h=e.type)});throw"Asset could not be read (File, Blob, ArrayBuffer, Uint8Array and number[] are valid"}();o=e}();o=Array.from(e)}();return Promise.resolve(f&&f.then?f.then(a):a())}catch(e){return Promise.reject(e)}},l=function(t){var i=this,c=this,s=this,u=t.concurrency,l=t.maxSingleFileSize,h=t.maxChunkSize,d=t.eventListener,f=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(o[n]=e[n]);return o}(t,o);this._actor=void 0,this._pLimit=void 0,this._maxSingleFileSize=void 0,this._maxChunkSize=void 0,this._eventListener=void 0,this.list=function(){return s._pLimit(function(){return s._actor.list({})})},this.batch=function(){var e=[];return{commit:function(){try{return Promise.resolve(s._pLimit(function(){return s._actor.create_batch({})})).then(function(t){var n=t.batch_id;return Promise.resolve(Promise.all(e.map(function(e){return e(n)}))).then(function(e){var t=e.flat();return Promise.resolve(s._pLimit(function(){return s._actor.commit_batch({batch_id:n,operations:t})})).then(function(){t.forEach(function(e){"DeleteAsset"in e&&s._eventListener({key:e.DeleteAsset.key,type:"delete"})})})})})}catch(e){return Promise.reject(e)}},insert:function(t,n){return Promise.resolve(a(t,n)).then(function(t){var n=[t.path,t.fileName].join("");return s._eventListener({key:n,type:"insert",progress:{current:0,total:t.content.length}}),e.push(function(e){try{var r=t.content.reduce(function(e,t,n){var r=Math.floor(n/s._maxChunkSize);return e[r]||(e[r]=[]),e[r].push(t),e},[]),o=0;return Promise.resolve(Promise.all(r.map(function(r){try{return Promise.resolve(s._pLimit(function(){return s._actor.create_chunk({content:r,batch_id:e})})).then(function(e){var i=e.chunk_id;return s._eventListener({key:n,type:"insert",progress:{current:o+=r.length,total:t.content.length}}),i})}catch(e){return Promise.reject(e)}}))).then(function(e){return[{CreateAsset:{key:n,content_type:t.contentType}},{SetAssetContent:{key:n,sha256:t.sha256?[t.sha256]:[],chunk_ids:e,content_encoding:t.contentEncoding}}]})}catch(e){return Promise.reject(e)}}),n})},delete:function(t){try{return e.push(function(){try{return Promise.resolve([{DeleteAsset:{key:t}}])}catch(e){return Promise.reject(e)}}),Promise.resolve()}catch(e){return Promise.reject(e)}}}},this.insert=function(e,t){return Promise.resolve(a(e,t)).then(function(e){var t=[e.path,e.fileName].join(""),n=function(){if(e.content.length<=i._maxSingleFileSize)return i._eventListener({key:t,type:"insert",progress:{current:0,total:e.content.length}}),Promise.resolve(i._pLimit(function(){return i._actor.store({key:t,content:e.content,content_type:e.contentType,sha256:e.sha256?[e.sha256]:[],content_encoding:e.contentEncoding})})).then(function(){});var n=i.batch();return Promise.resolve(n.insert(e.content,e)).then(function(){return Promise.resolve(n.commit()).then(function(){})})}();return n&&n.then?n.then(function(){return t}):t})},this.delete=function(e){try{return Promise.resolve(c._pLimit(function(){return c._actor.delete_content({key:e})})).then(function(){c._eventListener({key:e,type:"delete"})})}catch(e){return Promise.reject(e)}},this._actor=e.createActor(r,f),this._pLimit=n(null!=u?u:32),this._maxSingleFileSize=null!=l?l:45e4,this._maxChunkSize=null!=h?h:19e5,this._eventListener=null!=d?d:function(){return null}};export{l as AssetManager};
//# sourceMappingURL=index.module.mjs.map
