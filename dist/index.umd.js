!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@dfinity/agent"),require("file-type"),require("p-limit")):"function"==typeof define&&define.amd?define(["exports","@dfinity/agent","file-type","p-limit"],t):t((e||self).assets={},e.agent,e.fileType,e.pLimit)}(this,function(e,t,n,r){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/o(r),c=function(e){var t=e.IDL,n=t.Record({}),r=t.Nat,o=t.Text,i=t.Record({key:o,content_type:t.Text}),c=t.Record({key:o,content_encoding:t.Text}),s=t.Record({key:o}),u=t.Nat,a=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),chunk_ids:t.Vec(u),content_encoding:t.Text}),l=t.Variant({CreateAsset:i,UnsetAssetContent:c,DeleteAsset:s,SetAssetContent:a,Clear:n}),f=t.Tuple(t.Text,t.Text),h=t.Record({url:t.Text,method:t.Text,body:t.Vec(t.Nat8),headers:t.Vec(f)}),d=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text}),m=t.Record({token:t.Opt(d),body:t.Vec(t.Nat8)}),y=t.Variant({Callback:t.Record({token:d,callback:t.Func([d],[t.Opt(m)],["query"])})}),p=t.Record({body:t.Vec(t.Nat8),headers:t.Vec(f),streaming_strategy:t.Opt(y),status_code:t.Nat16}),_=t.Int;return t.Service({authorize:t.Func([t.Principal],[],[]),clear:t.Func([n],[],[]),commit_batch:t.Func([t.Record({batch_id:r,operations:t.Vec(l)})],[],[]),create_asset:t.Func([i],[],[]),create_batch:t.Func([t.Record({})],[t.Record({batch_id:r})],[]),create_chunk:t.Func([t.Record({content:t.Vec(t.Nat8),batch_id:r})],[t.Record({chunk_id:u})],[]),delete_content:t.Func([s],[],[]),get:t.Func([t.Record({key:o,accept_encodings:t.Vec(t.Text)})],[t.Record({content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text,total_length:t.Nat})],["query"]),get_chunk:t.Func([t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text})],[t.Record({content:t.Vec(t.Nat8)})],["query"]),http_request:t.Func([h],[p],["query"]),http_request_streaming_callback:t.Func([d],[t.Opt(m)],["query"]),list:t.Func([t.Record({})],[t.Vec(t.Record({key:o,encodings:t.Vec(t.Record({modified:_,sha256:t.Opt(t.Vec(t.Nat8)),length:t.Nat,content_encoding:t.Text})),content_type:t.Text}))],["query"]),set_asset_content:t.Func([a],[],[]),store:t.Func([t.Record({key:o,content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text})],[],[]),unset_asset_content:t.Func([c],[],[])})},s=["concurrency","maxSingleFileSize","maxChunkSize","eventListener"],u="undefined"!=typeof window&&void 0!==window.document,a="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,l="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,f=u?Promise.resolve(window.crypto):l?Promise.resolve(self.crypto):a?import("crypto"):Promise.resolve(),h=function(e,t){try{var r,o,i=function(e){var r;function i(e){function t(){return{fileName:c,path:h,content:o,contentType:s,contentEncoding:d,sha256:e}}var r=function(){if(!s)return Promise.resolve(n.fileTypeFromBuffer(Uint8Array.from(o))).then(function(e){var t=e.mime;s=void 0===t?"application/octet-stream":t})}();return r&&r.then?r.then(t):t()}h.startsWith("/")||(h="/"+h),h.endsWith("/")||(h+="/");var d=null!=(r=null==t?void 0:t.contentEncoding)?r:"identity",m=null==t?void 0:t.sha256;return m?Promise.resolve(function(e){try{var t,n=function(n){return t?n:function(){if(a)return Promise.resolve(f).then(function(t){return Array.from(t.createHash("sha256").update(new Uint8Array(e)).digest())})}()},r=function(){if(u||l)return Promise.resolve(f).then(function(n){return Promise.resolve(n.subtle.digest("SHA-256",new Uint8Array(e))).then(function(e){var n=Array.from(new Uint8Array(e));return t=1,n})})}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(e){return Promise.reject(e)}}(o)).then(i):i(m)},c=null==t?void 0:t.fileName,s=null==t?void 0:t.contentType,h=null!=(r=null==t?void 0:t.path)?r:"/",d=function(){if(!(e instanceof Uint8Array))return function(){if(!Array.isArray(e)||!e.every(function(e){return"number"==typeof e}))return function(){if(e instanceof Blob)return Promise.resolve(new Promise(function(t){var n=new FileReader;n.addEventListener("load",function(){t(Array.from(Uint8Array.from(n.result)))}),n.readAsArrayBuffer(e)})).then(function(t){if(o=t,!c){if(!(e instanceof File))throw'"fileName" property is required in options';c=e.name}s||(s=e.type)});throw"Asset could not be read (File, Blob, ArrayBuffer, Uint8Array and number[] are valid"}();o=e}();o=Array.from(e)}();return Promise.resolve(d&&d.then?d.then(i):i())}catch(e){return Promise.reject(e)}};e.AssetManager=function(e){var n=this,r=this,o=this,u=e.concurrency,a=e.maxSingleFileSize,l=e.maxChunkSize,f=e.eventListener,d=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(o[n]=e[n]);return o}(e,s);this._actor=void 0,this._pLimit=void 0,this._maxSingleFileSize=void 0,this._maxChunkSize=void 0,this._eventListener=void 0,this.list=function(){return o._pLimit(function(){return o._actor.list({})})},this.batch=function(){var e=[];return{commit:function(){try{return Promise.resolve(o._pLimit(function(){return o._actor.create_batch({})})).then(function(t){var n=t.batch_id;return Promise.resolve(Promise.all(e.map(function(e){return e(n)}))).then(function(e){var t=e.flat();return Promise.resolve(o._pLimit(function(){return o._actor.commit_batch({batch_id:n,operations:t})})).then(function(){t.forEach(function(e){"DeleteAsset"in e&&o._eventListener({key:e.DeleteAsset.key,type:"delete"})})})})})}catch(e){return Promise.reject(e)}},insert:function(t,n){return Promise.resolve(h(t,n)).then(function(t){var n=[t.path,t.fileName].join("");return o._eventListener({key:n,type:"insert",progress:{current:0,total:t.content.length}}),e.push(function(e){try{var r=t.content.reduce(function(e,t,n){var r=Math.floor(n/o._maxChunkSize);return e[r]||(e[r]=[]),e[r].push(t),e},[]),i=0;return Promise.resolve(Promise.all(r.map(function(r){try{return Promise.resolve(o._pLimit(function(){return o._actor.create_chunk({content:r,batch_id:e})})).then(function(e){var c=e.chunk_id;return o._eventListener({key:n,type:"insert",progress:{current:i+=r.length,total:t.content.length}}),c})}catch(e){return Promise.reject(e)}}))).then(function(e){return[{CreateAsset:{key:n,content_type:t.contentType}},{SetAssetContent:{key:n,sha256:t.sha256?[t.sha256]:[],chunk_ids:e,content_encoding:t.contentEncoding}}]})}catch(e){return Promise.reject(e)}}),n})},delete:function(t){try{return e.push(function(){try{return Promise.resolve([{DeleteAsset:{key:t}}])}catch(e){return Promise.reject(e)}}),Promise.resolve()}catch(e){return Promise.reject(e)}}}},this.insert=function(e,t){return Promise.resolve(h(e,t)).then(function(e){var t=[e.path,e.fileName].join(""),r=function(){if(e.content.length<=n._maxSingleFileSize)return n._eventListener({key:t,type:"insert",progress:{current:0,total:e.content.length}}),Promise.resolve(n._pLimit(function(){return n._actor.store({key:t,content:e.content,content_type:e.contentType,sha256:e.sha256?[e.sha256]:[],content_encoding:e.contentEncoding})})).then(function(){});var r=n.batch();return Promise.resolve(r.insert(e.content,e)).then(function(){return Promise.resolve(r.commit()).then(function(){})})}();return r&&r.then?r.then(function(){return t}):t})},this.delete=function(e){try{return Promise.resolve(r._pLimit(function(){return r._actor.delete_content({key:e})})).then(function(){r._eventListener({key:e,type:"delete"})})}catch(e){return Promise.reject(e)}},this._actor=t.Actor.createActor(c,d),this._pLimit=i.default(null!=u?u:32),this._maxSingleFileSize=null!=a?a:45e4,this._maxChunkSize=null!=l?l:19e5,this._eventListener=null!=f?f:function(){return null}}});
//# sourceMappingURL=index.umd.js.map
