var e=require("@dfinity/agent"),t=require("file-type");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,t}var o=/*#__PURE__*/n(require("p-limit")),i=function(e){var t=e.IDL,n=t.Record({}),r=t.Nat,o=t.Text,i=t.Record({key:o,content_type:t.Text}),c=t.Record({key:o,content_encoding:t.Text}),u=t.Record({key:o}),s=t.Nat,a=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),chunk_ids:t.Vec(s),content_encoding:t.Text}),l=t.Variant({CreateAsset:i,UnsetAssetContent:c,DeleteAsset:u,SetAssetContent:a,Clear:n}),f=t.Tuple(t.Text,t.Text),h=t.Record({url:t.Text,method:t.Text,body:t.Vec(t.Nat8),headers:t.Vec(f)}),d=t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text}),m=t.Record({token:t.Opt(d),body:t.Vec(t.Nat8)}),y=t.Variant({Callback:t.Record({token:d,callback:t.Func([d],[t.Opt(m)],["query"])})}),p=t.Record({body:t.Vec(t.Nat8),headers:t.Vec(f),streaming_strategy:t.Opt(y),status_code:t.Nat16}),_=t.Int;return t.Service({authorize:t.Func([t.Principal],[],[]),clear:t.Func([n],[],[]),commit_batch:t.Func([t.Record({batch_id:r,operations:t.Vec(l)})],[],[]),create_asset:t.Func([i],[],[]),create_batch:t.Func([t.Record({})],[t.Record({batch_id:r})],[]),create_chunk:t.Func([t.Record({content:t.Vec(t.Nat8),batch_id:r})],[t.Record({chunk_id:s})],[]),delete_content:t.Func([u],[],[]),get:t.Func([t.Record({key:o,accept_encodings:t.Vec(t.Text)})],[t.Record({content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text,total_length:t.Nat})],["query"]),get_chunk:t.Func([t.Record({key:o,sha256:t.Opt(t.Vec(t.Nat8)),index:t.Nat,content_encoding:t.Text})],[t.Record({content:t.Vec(t.Nat8)})],["query"]),http_request:t.Func([h],[p],["query"]),http_request_streaming_callback:t.Func([d],[t.Opt(m)],["query"]),list:t.Func([t.Record({})],[t.Vec(t.Record({key:o,encodings:t.Vec(t.Record({modified:_,sha256:t.Opt(t.Vec(t.Nat8)),length:t.Nat,content_encoding:t.Text})),content_type:t.Text}))],["query"]),set_asset_content:t.Func([a],[],[]),store:t.Func([t.Record({key:o,content:t.Vec(t.Nat8),sha256:t.Opt(t.Vec(t.Nat8)),content_type:t.Text,content_encoding:t.Text})],[],[]),unset_asset_content:t.Func([c],[],[])})},c=["concurrency","maxSingleFileSize","maxChunkSize","eventListener"],u="undefined"!=typeof window&&void 0!==window.document,s="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,a="object"==typeof self&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,l=u?Promise.resolve(window.crypto):a?Promise.resolve(self.crypto):s?Promise.resolve().then(function(){/*#__PURE__*/return r(require("crypto"))}):Promise.resolve(),f=function(e,n){try{var r,o,i=function(e){var r;function i(e){function n(){return{fileName:c,path:h,content:o,contentType:f,contentEncoding:d,sha256:e}}var r=function(){if(!f)return Promise.resolve(t.fileTypeFromBuffer(Uint8Array.from(o))).then(function(e){var t=e.mime;f=void 0===t?"application/octet-stream":t})}();return r&&r.then?r.then(n):n()}h.startsWith("/")||(h="/"+h),h.endsWith("/")||(h+="/");var d=null!=(r=null==n?void 0:n.contentEncoding)?r:"identity",m=null==n?void 0:n.sha256;return m?Promise.resolve(function(e){try{var t,n=function(n){return t?n:function(){if(s)return Promise.resolve(l).then(function(t){return Array.from(t.createHash("sha256").update(new Uint8Array(e)).digest())})}()},r=function(){if(u||a)return Promise.resolve(l).then(function(n){return Promise.resolve(n.subtle.digest("SHA-256",new Uint8Array(e))).then(function(e){var n=Array.from(new Uint8Array(e));return t=1,n})})}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(e){return Promise.reject(e)}}(o)).then(i):i(m)},c=null==n?void 0:n.fileName,f=null==n?void 0:n.contentType,h=null!=(r=null==n?void 0:n.path)?r:"/",d=function(){if(!(e instanceof Uint8Array))return function(){if(!Array.isArray(e)||!e.every(function(e){return"number"==typeof e}))return function(){if(e instanceof Blob)return Promise.resolve(new Promise(function(t){var n=new FileReader;n.addEventListener("load",function(){t(Array.from(Uint8Array.from(n.result)))}),n.readAsArrayBuffer(e)})).then(function(t){if(o=t,!c){if(!(e instanceof File))throw'"fileName" property is required in options';c=e.name}f||(f=e.type)});throw"Asset could not be read (File, Blob, ArrayBuffer, Uint8Array and number[] are valid"}();o=e}();o=Array.from(e)}();return Promise.resolve(d&&d.then?d.then(i):i())}catch(e){return Promise.reject(e)}};exports.AssetManager=function(t){var n=this,r=this,u=this,s=t.concurrency,a=t.maxSingleFileSize,l=t.maxChunkSize,h=t.eventListener,d=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(o[n]=e[n]);return o}(t,c);this._actor=void 0,this._pLimit=void 0,this._maxSingleFileSize=void 0,this._maxChunkSize=void 0,this._eventListener=void 0,this.list=function(){return u._pLimit(function(){return u._actor.list({})})},this.batch=function(){var e=[];return{commit:function(){try{return Promise.resolve(u._pLimit(function(){return u._actor.create_batch({})})).then(function(t){var n=t.batch_id;return Promise.resolve(Promise.all(e.map(function(e){return e(n)}))).then(function(e){var t=e.flat();return Promise.resolve(u._pLimit(function(){return u._actor.commit_batch({batch_id:n,operations:t})})).then(function(){t.forEach(function(e){"DeleteAsset"in e&&u._eventListener({key:e.DeleteAsset.key,type:"delete"})})})})})}catch(e){return Promise.reject(e)}},insert:function(t,n){return Promise.resolve(f(t,n)).then(function(t){var n=[t.path,t.fileName].join("");return u._eventListener({key:n,type:"insert",progress:{current:0,total:t.content.length}}),e.push(function(e){try{var r=t.content.reduce(function(e,t,n){var r=Math.floor(n/u._maxChunkSize);return e[r]||(e[r]=[]),e[r].push(t),e},[]),o=0;return Promise.resolve(Promise.all(r.map(function(r){try{return Promise.resolve(u._pLimit(function(){return u._actor.create_chunk({content:r,batch_id:e})})).then(function(e){var i=e.chunk_id;return u._eventListener({key:n,type:"insert",progress:{current:o+=r.length,total:t.content.length}}),i})}catch(e){return Promise.reject(e)}}))).then(function(e){return[{CreateAsset:{key:n,content_type:t.contentType}},{SetAssetContent:{key:n,sha256:t.sha256?[t.sha256]:[],chunk_ids:e,content_encoding:t.contentEncoding}}]})}catch(e){return Promise.reject(e)}}),n})},delete:function(t){try{return e.push(function(){try{return Promise.resolve([{DeleteAsset:{key:t}}])}catch(e){return Promise.reject(e)}}),Promise.resolve()}catch(e){return Promise.reject(e)}}}},this.insert=function(e,t){return Promise.resolve(f(e,t)).then(function(e){var t=[e.path,e.fileName].join(""),r=function(){if(e.content.length<=n._maxSingleFileSize)return n._eventListener({key:t,type:"insert",progress:{current:0,total:e.content.length}}),Promise.resolve(n._pLimit(function(){return n._actor.store({key:t,content:e.content,content_type:e.contentType,sha256:e.sha256?[e.sha256]:[],content_encoding:e.contentEncoding})})).then(function(){});var r=n.batch();return Promise.resolve(r.insert(e.content,e)).then(function(){return Promise.resolve(r.commit()).then(function(){})})}();return r&&r.then?r.then(function(){return t}):t})},this.delete=function(e){try{return Promise.resolve(r._pLimit(function(){return r._actor.delete_content({key:e})})).then(function(){r._eventListener({key:e,type:"delete"})})}catch(e){return Promise.reject(e)}},this._actor=e.Actor.createActor(i,d),this._pLimit=o.default(null!=s?s:32),this._maxSingleFileSize=null!=a?a:45e4,this._maxChunkSize=null!=l?l:19e5,this._eventListener=null!=h?h:function(){return null}};
//# sourceMappingURL=index.cjs.map
